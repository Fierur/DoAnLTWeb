@{
    ViewBag.Title = "Thanh toán";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var khachHang = ViewBag.KhachHang;
    var chiTietGH = ViewBag.ChiTietGH as List<DoAnLTWeb.Models.ChiTietGH>;
    double tongTien = ViewBag.TongTienSanPham ?? 0;
}

<h2 class="mt-4 text-center">Thanh toán</h2>

@if (TempData["Error"] != null)
{
    <div class="alert alert-danger">@TempData["Error"]</div>
}

<div class="row mt-4">
    <div class="col-md-8">
        <h4>Địa chỉ giao hàng</h4>
        <form method="post" action="@Url.Action("PlaceOrder", "Order")">
            @Html.AntiForgeryToken()

            <div class="form-group">
                <label>Chọn địa chỉ có sẵn:</label>
                <select name="diaChiCoSanId" class="form-control">
                    <option value="">-- Chọn địa chỉ --</option>
                    @foreach (var dc in ViewBag.DiaChiList as List<DoAnLTWeb.Models.DiaChiGiaoHang>)
                    {
                        <option value="@dc.MaDCGH">@dc.HoTenNN - @dc.SoNha</option>
                    }
                </select>
            </div>

            <hr />
            <h5>Hoặc nhập địa chỉ mới</h5>
            <div class="form-group">
                <label>Họ tên người nhận</label>
                <input type="text" name="hoTenNN" class="form-control" placeholder="Nhập họ tên" />
            </div>
            <div class="form-group mt-2">
                <label>Số nhà / Đường</label>
                <input type="text" name="soNha" class="form-control" placeholder="Số nhà, đường..." />
            </div>
            <div class="form-group mt-2">
                <label>Thành phố</label>
                @Html.DropDownList("maTP", ViewBag.ThanhPhoList as SelectList, "-- Chọn thành phố --", new { @class = "form-control", id = "ddlTP" })
            </div>
            <div class="form-group mt-2">
                <label>Quận huyện</label>
                <select id="ddlQH" class="form-control"></select>
            </div>
            <div class="form-group mt-2">
                <label>Xã phường</label>
                <select name="maXP" id="ddlXP" class="form-control"></select>
            </div>
            <div class="form-group mt-2">
                <label>Ghi chú</label>
                <textarea name="ghiChu" class="form-control"></textarea>
            </div>
            <div class="form-group mt-2">
                <label>Hình thức thanh toán</label>
                @Html.DropDownList("maHTTT", ViewBag.HinhThucThanhToanList as SelectList, "-- Chọn hình thức --", new { @class = "form-control" })
            </div>

            <button type="submit" class="btn btn-success mt-3 w-100">Đặt hàng</button>
        </form>
    </div>

    <div class="col-md-4">
        <h4>Đơn hàng của bạn</h4>
        <ul class="list-group">
            @foreach (var item in chiTietGH)
            {
                var sach = item.Sach;
                <li class="list-group-item d-flex justify-content-between">
                    <span>@sach.TenSach (x@item.SoLuongSachCTGH)</span>
                    <span>@String.Format("{0:N0} đ", sach.Gia * item.SoLuongSachCTGH)</span>
                </li>
            }
        </ul>
        <div class="mt-3 text-end">
            <strong>Tổng cộng: @String.Format("{0:N0} đ", tongTien)</strong>
        </div>
    </div>
</div>

@section Scripts {
    <script>
    // AJAX load quận huyện và xã phường
    $("#ddlTP").change(function () {
        var maTP = $(this).val();
        $("#ddlQH").empty();
        $("#ddlXP").empty();
        if (maTP) {
            $.getJSON('/Order/GetQuanHuyen', { maTP: maTP }, function (data) {
                $("#ddlQH").append('<option value="">-- Chọn quận huyện --</option>');
                $.each(data, function (i, item) {
                    $("#ddlQH").append('<option value="' + item.MaQH + '">' + item.TenQH + '</option>');
                });
            });
        }
    });
    $("#ddlQH").change(function () {
        var maQH = $(this).val();
        $("#ddlXP").empty();
        if (maQH) {
            $.getJSON('/Order/GetXaPhuong', { maQH: maQH }, function (data) {
                $("#ddlXP").append('<option value="">-- Chọn xã phường --</option>');
                $.each(data, function (i, item) {
                    $("#ddlXP").append('<option value="' + item.MaXP + '">' + item.TenXP + ' (+' + item.ChiPhiGHXP + ' đ)</option>');
                });
            });
        }
    });
    </script>
}
