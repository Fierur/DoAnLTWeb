@{
    ViewBag.Title = "Chi tiết đơn hàng";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var donHang = ViewBag.DonHang as DoAnLTWeb.Models.DonDatHang;
    var chiTiet = ViewBag.ChiTietDonHang as List<DoAnLTWeb.Models.ChiTietDonDH>;
    var lichSu = ViewBag.LichSuTrangThai as List<DoAnLTWeb.Models.ChiTietTrangThai>;

    // Lấy trạng thái hiện tại (mới nhất)
    var trangThaiHienTai = lichSu?.OrderByDescending(t => t.NgayCapNhatTT).FirstOrDefault();
}

<h2 class="mt-4 text-center">Chi tiết đơn hàng #@donHang.MaDon</h2>

@if (TempData["Success"] != null)
{
    <div class="alert alert-success alert-dismissible fade show mt-3" role="alert">
        <i class="fas fa-check-circle"></i> @TempData["Success"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

@if (TempData["Error"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show mt-3" role="alert">
        <i class="fas fa-exclamation-circle"></i> @TempData["Error"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

<div class="card p-3 mt-3 shadow-sm">
    <p>
        <strong>Ngày đặt:</strong> @(donHang.NgayDat.HasValue ? donHang.NgayDat.Value.ToString("dd/MM/yyyy") : "")
    </p>
    <p><strong>Tổng tiền:</strong> @String.Format("{0:N0} đ", donHang.TongTien)</p>

    @* Hiển thị trạng thái hiện tại *@
    <p>
        <strong>Trạng thái:</strong>
        @if (trangThaiHienTai != null && trangThaiHienTai.TrangThai != null)
        {
            var tenTrangThai = trangThaiHienTai.TrangThai.TenTT;
            var badgeClass = "badge ";

            switch (trangThaiHienTai.MaTT)
            {
                case 1001: // Chờ xác nhận
                    badgeClass += "bg-warning text-dark";
                    break;
                case 1002: // Đang giao
                    badgeClass += "bg-info";
                    break;
                case 1003: // Hoàn tất
                    badgeClass += "bg-success";
                    break;
                case 1004: // Đã hủy
                    badgeClass += "bg-danger";
                    break;
                default:
                    badgeClass += "bg-secondary";
                    break;
            }

            <span class="@badgeClass fs-6 px-3 py-2">
                <i class="fas fa-circle-info"></i> @tenTrangThai
            </span>
        }
        else
        {
            <span class="badge bg-secondary fs-6">N/A</span>
        }
    </p>

    @* Nút hủy đơn hàng - chỉ hiển thị khi đang "Chờ xác nhận" *@
    @if (trangThaiHienTai != null && trangThaiHienTai.MaTT == 1001)
    {
        <div class="mt-3">
            <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#cancelOrderModal">
                <i class="fas fa-times-circle"></i> Hủy đơn hàng
            </button>
        </div>
    }

    <h5 class="mt-4">Danh sách sản phẩm</h5>
    <table class="table table-bordered">
        <thead class="table-light">
            <tr>
                <th>Tên sách</th>
                <th style="width: 20%;">Số lượng</th>
                <th style="width: 25%;">Đơn giá</th>
                <th style="width: 25%;">Thành tiền</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in chiTiet)
            {
                <tr>
                    <td>@item.Sach.TenSach</td>
                    <td class="text-center">@item.SoLuongCTDDH</td>
                    <td>@String.Format("{0:N0} đ", item.DonGiaCTDDH)</td>
                    <td class="fw-bold">@String.Format("{0:N0} đ", item.DonGiaCTDDH * item.SoLuongCTDDH)</td>
                </tr>
            }
        </tbody>
        <tfoot class="table-light">
            <tr>
                <td colspan="3" class="text-end fw-bold">Phí vận chuyển:</td>
                <td class="fw-bold">@String.Format("{0:N0} đ", donHang.PhiShip)</td>
            </tr>
            <tr>
                <td colspan="3" class="text-end fw-bold">Thuế VAT (@((donHang.ThueVAT ?? 0) * 100)%):</td>
                <td class="fw-bold">@String.Format("{0:N0} đ", chiTiet.Sum(c => c.DonGiaCTDDH * c.SoLuongCTDDH) * (donHang.ThueVAT ?? 0))</td>
            </tr>
            <tr class="table-warning">
                <td colspan="3" class="text-end fw-bold fs-5">TỔNG CỘNG:</td>
                <td class="fw-bold text-danger fs-5">@String.Format("{0:N0} đ", donHang.TongTien)</td>
            </tr>
        </tfoot>
    </table>

    @* Lịch sử trạng thái *@
    @if (lichSu != null && lichSu.Any())
    {
        <h5 class="mt-4">Lịch sử trạng thái đơn hàng</h5>
        <div class="timeline">
            @foreach (var item in lichSu.OrderBy(t => t.NgayCapNhatTT))
            {
                <div class="timeline-item mb-3">
                    <div class="d-flex align-items-start">
                        <div class="timeline-marker me-3">
                            <i class="fas fa-circle text-primary"></i>
                        </div>
                        <div>
                            <p class="mb-1">
                                <strong>@item.TrangThai.TenTT</strong>
                                <span class="text-muted ms-2">
                                    @(item.NgayCapNhatTT.HasValue ? item.NgayCapNhatTT.Value.ToString("dd/MM/yyyy HH:mm") : "")
                                </span>
                            </p>
                            @if (!string.IsNullOrEmpty(item.GhiChuTT))
                            {
                                <p class="text-muted mb-0"><small>@item.GhiChuTT</small></p>
                            }
                        </div>
                    </div>
                </div>
            }
        </div>
    }

    <div class="mt-4">
        @Html.ActionLink("← Quay lại danh sách đơn hàng", "MyOrders", "Order", null, new { @class = "btn btn-secondary" })
    </div>
</div>

@* Modal xác nhận hủy đơn hàng *@
<div class="modal fade" id="cancelOrderModal" tabindex="-1" aria-labelledby="cancelOrderModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="cancelOrderModalLabel">
                    <i class="fas fa-exclamation-triangle"></i> Xác nhận hủy đơn hàng
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="mb-0">Bạn có chắc chắn muốn hủy đơn hàng <strong>#@donHang.MaDon</strong> không?</p>
                <p class="text-muted mt-2"><small>Lưu ý: Hành động này không thể hoàn tác!</small></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Không
                </button>
                @using (Html.BeginForm("CancelOrder", "Order", FormMethod.Post, new { @class = "d-inline" }))
                {
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="maDon" value="@donHang.MaDon" />
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-check"></i> Đồng ý hủy
                    </button>
                }
            </div>
        </div>
    </div>
</div>

<style>
    .timeline-marker {
        font-size: 12px;
        margin-top: 2px;
    }

    .timeline-item {
        border-left: 2px solid #e9ecef;
        padding-left: 20px;
        position: relative;
    }

        .timeline-item:last-child {
            border-left: none;
        }

    .badge {
        font-weight: 500;
    }
</style>