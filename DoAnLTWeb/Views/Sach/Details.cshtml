@model DoAnLTWeb.Models.Sach

@{
    ViewBag.Title = Model.TenSach;
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container mt-4">
    @Html.AntiForgeryToken()
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">@Html.ActionLink("Trang chủ", "Index", "Sach")</li>
            <li class="breadcrumb-item">@Html.ActionLink("Danh sách sách", "Index", "Sach")</li>
            <li class="breadcrumb-item active" aria-current="page">@Model.TenSach</li>
        </ol>
    </nav>

    <!-- Chi tiết sách -->
    <div class="row">
        <!-- Hình ảnh sách -->
        <div class="col-md-4">
            <div class="card shadow">
                @if (!string.IsNullOrEmpty(Model.Hinh))
                {
                    <img src="@Url.Content("~/Images/" + Model.Hinh)"
                         class="card-img-top"
                         alt="@Model.TenSach"
                         style="width: 100%; height: auto;"
                         onerror="this.src='@Url.Content("~/Images/no-image.jpg")'" />
                }
                else
                {
                    <div class="card-img-top bg-secondary d-flex align-items-center justify-content-center"
                         style="height: 400px;">
                        <span class="text-white">Không có ảnh</span>
                    </div>
                }
            </div>
        </div>

        <!-- Thông tin sách -->
        <div class="col-md-8">
            <h2 class="mb-3">@Model.TenSach</h2>

            <div class="card mb-3">
                <div class="card-body">
                    <h4 class="text-danger mb-3">
                        Giá: @(Model.Gia != null ? string.Format("{0:N0} ₫", Model.Gia) : "Liên hệ")
                    </h4>

                    <table class="table table-borderless">
                        <tbody>
                            <tr>
                                <th style="width: 30%;">Thể loại:</th>
                                <td>
                                    @if (Model.TheLoaiSaches != null && Model.TheLoaiSaches.Any())
                                    {
                                        foreach (var theLoai in Model.TheLoaiSaches)
                                        {
                                            @Html.ActionLink(theLoai.TenTLS, "Index", new { theLoaiId = theLoai.MaTLS }, new { @class = "badge bg-primary text-decoration-none me-1" })
                                        }
                                    }
                                    else if (Model.TheLoaiSach != null)
                                    {
                                        @Html.ActionLink(Model.TheLoaiSach.TenTLS, "Index", new { theLoaiId = Model.MaTLS }, new { @class = "badge bg-primary text-decoration-none" })
                                    }
                                    else
                                    {
                                        <span class="text-muted">N/A</span>
                                    }
                                </td>
                            </tr>
                            <tr>
                                <th>Nhà xuất bản:</th>
                                <td>@(Model.NhaXuatBan != null ? Model.NhaXuatBan.TenNXB : "N/A")</td>
                            </tr>
                            <tr>
                                <th>Tác giả:</th>
                                <td>
                                    @if (Model.TacGias != null && Model.TacGias.Any())
                                    {
                                        @(string.Join(", ", Model.TacGias.Select(t => t.HoTenTG)))
                                    }
                                    else
                                    {
                                        <span class="text-muted">N/A</span>
                                    }
                                </td>
                            </tr>
                            <tr>
                                <th>Ngôn ngữ:</th>
                                <td>@(Model.AddNgonNgu ?? "N/A")</td>
                            </tr>
                            <tr>
                                <th>Số trang:</th>
                                <td>@(Model.SoTrang != null ? Model.SoTrang.ToString() : "N/A")</td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="d-grid gap-2">
                        <button class="btn btn-success btn-lg w-100" id="btnAddToCart">
                            <i class="fas fa-cart-plus"></i> Thêm vào giỏ hàng
                        </button>

                        <button class="btn btn-danger btn-lg w-100" id="btnBuyNow">
                            <i class="fas fa-bolt"></i> Mua ngay
                        </button>
                    </div>

                </div>
            </div>

            <!-- Mô tả sách -->
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Mô tả sản phẩm</h5>
                </div>
                <div class="card-body">
                    <p>@(Model.Mota ?? "Chưa có mô tả cho sách này.")</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Sách liên quan -->
    @if (ViewBag.SachLienQuan != null && ((List<DoAnLTWeb.Models.Sach>)ViewBag.SachLienQuan).Any())
    {
        <div class="mt-5">
            <h3 class="mb-4">Sách liên quan</h3>
            <div class="row">
                @foreach (var item in (List<DoAnLTWeb.Models.Sach>)ViewBag.SachLienQuan)
                {
                    <div class="col-md-3 mb-4">
                        <div class="card h-100 shadow-sm">
                            @if (!string.IsNullOrEmpty(item.Hinh))
                            {
                                <img src="@Url.Content("~/Images/" + item.Hinh)"
                                     class="card-img-top"
                                     alt="@item.TenSach"
                                     style="height: 250px; object-fit: cover;"
                                     onerror="this.src='@Url.Content("~/Images/no-image.jpg")'" />
                            }
                            else
                            {
                                <div class="card-img-top bg-secondary d-flex align-items-center justify-content-center"
                                     style="height: 250px;">
                                    <span class="text-white">Không có ảnh</span>
                                </div>
                            }

                            <div class="card-body d-flex flex-column">
                                <h6 class="card-title">@item.TenSach</h6>
                                <p class="text-danger mb-2">
                                    <strong>@(item.Gia != null ? string.Format("{0:N0} ₫", item.Gia) : "Liên hệ")</strong>
                                </p>
                                <div class="mt-auto">
                                    @Html.ActionLink("Xem chi tiết", "Details", new { id = item.MaSach }, new { @class = "btn btn-primary btn-sm w-100" })
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    }

    <!-- Nút quay lại -->
    <div class="mt-4 mb-4">
        @Html.ActionLink("← Quay lại danh sách", "Index", null, new { @class = "btn btn-secondary" })
    </div>
</div>


@section Scripts {
    <!-- SweetAlert2 CDN -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        $(document).ready(function () {

            // Hàm hiển thị thông báo đăng nhập
            function showLoginPrompt() {
                Swal.fire({
                    title: "Bạn chưa đăng nhập!",
                    text: "Bạn cần đăng nhập để tiếp tục.",
                    icon: "warning",
                    showCancelButton: true,
                    confirmButtonText: "Đăng nhập ngay",
                    cancelButtonText: "Hủy",
                    confirmButtonColor: "#3085d6",
                    cancelButtonColor: "#d33"
                }).then((result) => {
                    if (result.isConfirmed) {
                        window.location.href =
                            '@Url.Action("Login", "Account")' +
                            '?returnUrl=' + encodeURIComponent(window.location.href);
                    }
                });
            }

            // Khi bấm Thêm vào giỏ hàng
            $("#btnAddToCart").click(function () {
                $.ajax({
                    url: '@Url.Action("AddToCart", "Sach")',
                    type: "POST",
                    data: {
                        __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val(),
                        bookId: @Model.MaSach,
                        quantity: 1
                    },
                    success: function (res) {
                        if (res.requireLogin) {
                            showLoginPrompt();
                        } else if (res.success) {
                            Swal.fire({
                                icon: "success",
                                title: "Đã thêm vào giỏ hàng!",
                                text: res.message,
                                timer: 1500,
                                showConfirmButton: false
                            });
                        } else {
                            Swal.fire("Lỗi", res.message, "error");
                        }
                    },
                    error: function () {
                        Swal.fire("Lỗi", "Không thể thêm sản phẩm. Vui lòng thử lại!", "error");
                    }
                });
            });

            // Khi bấm Mua ngay
            $("#btnBuyNow").click(function () {
                $.ajax({
                    url: '@Url.Action("AddToCart", "Sach")',
                    type: "POST",
                    data: {
                        __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val(),
                        bookId: @Model.MaSach,
                        quantity: 1
                    },
                    success: function (res) {
                        if (res.requireLogin) {
                            showLoginPrompt();
                        } else if (res.success) {
                            Swal.fire({
                                icon: "success",
                                title: "Thành công!",
                                text: "Sản phẩm đã được thêm. Đang chuyển đến trang thanh toán...",
                                showConfirmButton: false,
                                timer: 1200
                            }).then(() => {
                                window.location.href = '@Url.Action("Checkout", "Order")';
                            });
                        } else {
                            Swal.fire("Lỗi", res.message, "error");
                        }
                    },
                    error: function () {
                        Swal.fire("Lỗi", "Không thể mua ngay. Vui lòng thử lại!", "error");
                    }
                });
            });
        });
    </script>
}
