@{
    ViewBag.Title = "Giỏ hàng của bạn";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var cartItems = ViewBag.CartItems as List<DoAnLTWeb.Models.ChiTietGH>;
    double tongTien = ViewBag.TongTien ?? 0;
}

<div class="container mt-4">
    @Html.AntiForgeryToken()
    <h2 class="mb-4"><i class="fas fa-shopping-cart"></i> Giỏ hàng của bạn</h2>

    @if (cartItems == null || !cartItems.Any())
    {
        <div class="alert alert-warning text-center">
            <i class="fas fa-info-circle fa-2x mb-3"></i>
            <h4>Giỏ hàng trống</h4>
            <p>Hãy chọn một vài cuốn sách yêu thích nhé!</p>
            <a href="@Url.Action("Index", "Sach")" class="btn btn-primary">
                <i class="fas fa-arrow-left"></i> Tiếp tục mua sắm
            </a>
        </div>
    }
    else
    {
        <table class="table table-bordered align-middle shadow-sm">
            <thead class="table-light">
                <tr>
                    <th style="width: 10%;">Ảnh</th>
                    <th>Tên sách</th>
                    <th style="width: 15%;">Đơn giá</th>
                    <th style="width: 15%;">Số lượng</th>
                    <th style="width: 15%;">Thành tiền</th>
                    <th style="width: 10%;">Hành động</th>
                </tr>
            </thead>
            <tbody id="cartTableBody">
                @foreach (var item in cartItems)
                {
                    var sach = item.Sach;
                    if (sach == null) { continue; }
                    double donGia = sach.Gia ?? 0;
                    int soLuong = item.SoLuongSachCTGH ?? 0;
                    double thanhTien = donGia * soLuong;

                    <tr data-book-id="@item.MaSach">
                        <td>
                            <img src="@Url.Content("~/Images/" + sach.Hinh)"
                                 alt="@sach.TenSach"
                                 class="img-fluid rounded"
                                 style="max-height: 80px;"
                                 onerror="this.src='@Url.Content("~/Images/no-image.jpg")'" />
                        </td>
                        <td>
                            <strong>@sach.TenSach</strong><br />
                            <small class="text-muted">Thể loại: @(sach.TheLoaiSach?.TenTLS ?? "N/A")</small>
                        </td>
                        <td class="item-price" data-price="@donGia">@string.Format("{0:N0} ₫", donGia)</td>
                        <td>
                            <div class="input-group input-group-sm">
                                <button class="btn btn-outline-secondary btn-minus" type="button">-</button>
                                <input type="number" class="form-control text-center cart-qty"
                                       value="@soLuong" min="1" style="max-width: 60px;" />
                                <button class="btn btn-outline-secondary btn-plus" type="button">+</button>
                            </div>
                        </td>
                        <td class="item-total">@string.Format("{0:N0} ₫", thanhTien)</td>
                        <td>
                            <button class="btn btn-danger btn-sm btn-remove" title="Xóa sản phẩm">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>

        <div class="d-flex justify-content-between align-items-center mt-4">
            <h4>Tổng cộng: <span id="cartTotal" class="text-danger">@string.Format("{0:N0} ₫", tongTien)</span></h4>
            <div>
                <a href="@Url.Action("Index", "Sach")" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left"></i> Tiếp tục mua sắm
                </a>
                <a href="@Url.Action("Checkout", "Order")" class="btn btn-success">
                    <i class="fas fa-credit-card"></i> Thanh toán
                </a>
            </div>
        </div>
    }
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            // Hàm tính toán lại tổng tiền
            function recalculateTotal() {
                var total = 0;
                $('#cartTableBody tr').each(function () {
                    var price = parseFloat($(this).find('.item-price').data('price'));
                    var qty = parseInt($(this).find('.cart-qty').val());
                    total += price * qty;
                });
                $('#cartTotal').text(total.toLocaleString('vi-VN') + ' ₫');
            }

            // Giảm số lượng
            $(".btn-minus").click(function () {
                var row = $(this).closest("tr");
                var input = row.find(".cart-qty");
                var value = parseInt(input.val()) - 1;
                if (value >= 1) {
                    input.val(value).trigger("change");
                }
            });

            // Tăng số lượng
            $(".btn-plus").click(function () {
                var row = $(this).closest("tr");
                var input = row.find(".cart-qty");
                var value = parseInt(input.val()) + 1;
                input.val(value).trigger("change");
            });

            // Cập nhật số lượng
            $(".cart-qty").change(function () {
                var row = $(this).closest("tr");
                var bookId = row.data("book-id");
                var quantity = parseInt($(this).val());

                if (quantity < 1) {
                    $(this).val(1);
                    return;
                }

                $.ajax({
                    url: '@Url.Action("UpdateCartQuantity", "Sach")',
                    type: "POST",
                    data: {
                        __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val(),
                        bookId: bookId,
                        quantity: quantity
                    },
                    success: function (res) {
                        if (res.success) {
                            // Cập nhật thành tiền của dòng
                            row.find(".item-total").text(res.itemTotal.toLocaleString("vi-VN") + " ₫");
                            // Cập nhật tổng tiền giỏ hàng
                            $("#cartTotal").text(res.cartTotal.toLocaleString("vi-VN") + " ₫");
                            // Cập nhật badge giỏ hàng
                            if (window.updateCartCount) {
                                window.updateCartCount();
                            }
                        } else {
                            alert(res.message);
                            location.reload();
                        }
                    },
                    error: function () {
                        alert('Có lỗi xảy ra. Vui lòng thử lại!');
                        location.reload();
                    }
                });
            });

            // Xóa sản phẩm
            $(".btn-remove").click(function () {
                if (!confirm("Bạn có chắc muốn xóa sản phẩm này?")) return;

                var row = $(this).closest("tr");
                var bookId = row.data("book-id");

                $.ajax({
                    url: '@Url.Action("RemoveFromCart", "Sach")',
                    type: "POST",
                    data: {
                        __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val(),
                        bookId: bookId
                    },
                    success: function (res) {
                        if (res.success) {
                            // Xóa dòng với hiệu ứng
                            row.fadeOut(300, function () {
                                $(this).remove();

                                // Kiểm tra nếu giỏ hàng rỗng thì reload trang
                                if ($("#cartTableBody tr").length === 0) {
                                    location.reload();
                                } else {
                                    // Cập nhật lại tổng tiền
                                    recalculateTotal();
                                }
                            });

                            // Cập nhật badge giỏ hàng
                            if (window.updateCartCount) {
                                window.updateCartCount();
                            }
                        } else {
                            alert(res.message);
                        }
                    },
                    error: function () {
                        alert('Có lỗi xảy ra. Vui lòng thử lại!');
                    }
                });
            });
        });
    </script>
}